<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calibrador Visual de PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importamos la librería PDF.js de Mozilla -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.mjs" type="module"></script>
    <style>
        body { font-family: sans-serif; cursor: none; }
        canvas { border: 1px solid #ccc; cursor: crosshair; }
        #tooltip {
            position: absolute;
            display: none;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            font-family: monospace;
            pointer-events: none; /* Evita que el tooltip interfiera con el ratón */
            white-space: nowrap;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white p-6 rounded-lg shadow-md text-center">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Calibrador Visual de PDF</h1>
        <p class="text-gray-600 mb-4">Sube tu plantilla PDF para encontrar las coordenadas (x, y) para tu código. Haz clic para dejar un marcador temporal.</p>

        <input type="file" id="pdf-upload" class="mb-4 block w-full text-sm text-gray-500
            file:mr-4 file:py-2 file:px-4
            file:rounded-full file:border-0
            file:text-sm file:font-semibold
            file:bg-indigo-50 file:text-indigo-700
            hover:file:bg-indigo-100"
        />

        <div id="coords-display" class="my-4 p-3 bg-indigo-100 border-l-4 border-indigo-500 text-indigo-800 font-mono text-lg rounded-md h-12 flex items-center justify-center">
            Sube un PDF para empezar...
        </div>

        <div class="bg-gray-200 p-2 inline-block">
            <canvas id="pdf-canvas"></canvas>
        </div>
    </div>

    <!-- El tooltip que seguirá al ratón -->
    <div id="tooltip"></div>

    <script type="module">
        // Importamos pdfjsLib del script que cargamos en el head
        const { pdfjsLib } = globalThis;
        // Le indicamos dónde encontrar los archivos "worker" que necesita
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://mozilla.github.io/pdf.js/build/pdf.worker.mjs`;

        const fileInput = document.getElementById('pdf-upload');
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const coordsDisplay = document.getElementById('coords-display');
        const tooltip = document.getElementById('tooltip');

        let currentPdfPage = null;
        let clickedPoints = [];

        // Función para redibujar todo: el PDF y los puntos
        const redrawCanvas = async () => {
            if (!currentPdfPage) return;

            const viewport = currentPdfPage.getViewport({ scale: 1.5 });
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            await currentPdfPage.render(renderContext).promise;

            // Dibujamos los puntos guardados y sus coordenadas
            clickedPoints.forEach(point => {
                const canvasX = point.x * 1.5;
                const canvasY = canvas.height - (point.y * 1.5);
                
                // Dibuja el círculo rojo
                ctx.beginPath();
                ctx.arc(canvasX, canvasY, 5, 0, 2 * Math.PI, false);
                ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                ctx.fill();

                // Dibuja el texto de las coordenadas al lado del punto
                ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                ctx.font = 'bold 12px sans-serif';
                const text = `(x:${point.x.toFixed(0)}, y:${point.y.toFixed(0)})`;
                ctx.fillText(text, canvasX + 10, canvasY + 5);
            });
        };

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                coordsDisplay.textContent = "Por favor, sube un archivo PDF.";
                return;
            }
            
            clickedPoints = [];
            coordsDisplay.textContent = "Cargando PDF...";
            
            const fileReader = new FileReader();
            fileReader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                currentPdfPage = await pdf.getPage(1);
                await redrawCanvas();
                coordsDisplay.textContent = "¡Listo! Mueve el ratón y haz clic.";
            };
            fileReader.readAsArrayBuffer(file);
        });

        const getCoordsFromEvent = (event) => {
            const rect = canvas.getBoundingClientRect();
            const scale = canvas.width / rect.width;
            const canvasX = (event.clientX - rect.left) * scale;
            const canvasY = (event.clientY - rect.top) * scale;
            const pdfLibX = canvasX / 1.5;
            const pdfLibY = (canvas.height - canvasY) / 1.5;
            return { x: pdfLibX, y: pdfLibY };
        };

        canvas.addEventListener('mousemove', (event) => {
            if (!currentPdfPage) return;
            const coords = getCoordsFromEvent(event);
            coordsDisplay.innerHTML = `<strong>x:</strong> ${coords.x.toFixed(2)} &nbsp;&nbsp;&nbsp; <strong>y:</strong> ${coords.y.toFixed(2)}`;
            tooltip.style.display = 'block';
            tooltip.style.left = `${event.pageX + 15}px`;
            tooltip.style.top = `${event.pageY + 15}px`;
            tooltip.innerHTML = `x:${coords.x.toFixed(0)}, y:${coords.y.toFixed(0)}`;
        });

        canvas.addEventListener('mouseout', () => {
            tooltip.style.display = 'none';
        });

        canvas.addEventListener('click', (event) => {
            if (!currentPdfPage) return;
            const coords = getCoordsFromEvent(event);
            clickedPoints.push(coords);
            redrawCanvas(); // Redibujamos el canvas para mostrar el nuevo punto y su texto
        });
    </script>
</body>
</html>

